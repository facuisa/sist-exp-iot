<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Estad√≠sticas de fallas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- CSS global -->
  <link href="{{ url_for('static', path='style.css') }}" rel="stylesheet">



  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- plugin de etiquetas -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
</head>
<body>
  <div class="wrap">
    <h1>üìà Estad√≠sticas de fallas</h1>
    <p class="totales">Total de casos: <b id="n_casos">‚Äî</b></p>
    <div class="acciones">
      <a class="btn" href="/panel">üè† Volver al panel principal</a>
    </div>


    <div id="err"></div>

    <div class="graficos-grid">
      <div class="card">
        <h3>Top dispositivos</h3>
        <canvas id="chartDevice"></canvas>
      </div>

      <div class="card">
        <h3>Top s√≠ntomas</h3>
        <canvas id="chartSymptom"></canvas>
      </div>

      <div class="card">
        <h3>Categor√≠as</h3>
        <canvas id="chartCategory"></canvas>
      </div>

      <div class="card">
        <h3>Criticidad</h3>
        <canvas id="chartCrit"></canvas>
      </div>
    </div>
  </div>

  <!-- Tema oscuro global para Chart.js -->
  <script>
  // Config global Chart.js: solo lo seguro
  if (window.Chart) {
    Chart.defaults.color = '#e0e0e0';
    Chart.defaults.borderColor = 'rgba(255,255,255,0.15)';
    Chart.defaults.plugins.legend.labels.color = '#e0e0e0';
    Chart.defaults.plugins.tooltip.titleColor = '#121212';
    Chart.defaults.plugins.tooltip.bodyColor = '#121212';
    Chart.defaults.plugins.tooltip.backgroundColor = '#e0e0e0';
  }

  // Registramos plugin de datalabels si est√° cargado
  if (window.ChartDataLabels) {
    Chart.register(ChartDataLabels);
  } else {
    console.error("DEBUG: ChartDataLabels no est√° disponible.");
  }

  async function loadStats(){
    console.log("DEBUG: loadStats() INICIO");

    const showError = (msg) => {
      const box = document.getElementById('err');
      if (box) {
        box.textContent = msg || 'No se pudieron cargar las estad√≠sticas.';
        box.style.display = 'block';
      }
    };

    try {
      console.log("DEBUG: solicitando /api/stats ...");
      const res = await fetch("/api/stats", { headers: { "Accept": "application/json" } });
      console.log("DEBUG: respuesta fetch", res.status);

      if (!res.ok) {
        throw new Error(`HTTP ${res.status}`);
      }

      const data = await res.json();
      console.log("DEBUG: data recibida", data);

      if (!data || typeof data !== "object") {
        throw new Error("Respuesta vac√≠a o inv√°lida de /api/stats");
      }

      // Total de casos
      const n = (typeof data.n_casos === "number")
        ? data.n_casos
        : Number(data?.n_casos || 0);

      const nNode = document.getElementById("n_casos");
      if (nNode) nNode.textContent = n;
      console.log("DEBUG: n_casos calculado:", n);

      // Datos para gr√°ficos
      const devL = Object.keys(data.by_device || {});
      const devV = Object.values(data.by_device || {});
      const symL = Object.keys(data.by_symptom || {});
      const symV = Object.values(data.by_symptom || {});
      const catL = Object.keys(data.by_category || {});
      const catV = Object.values(data.by_category || {});
      const criL = Object.keys(data.by_criticidad || {});
      const criV = Object.values(data.by_criticidad || {});

      console.log("DEBUG: devL/devV", devL, devV);
      console.log("DEBUG: criL/criV", criL, criV);

      const toNums = (arr) => arr.map(v => (v == null ? 0 : Number(v)));

      const pctFormatter = (value, ctx) => {
        const arr = ctx.chart.data.datasets[0].data;
        const total = arr.reduce((a,b)=>a+b,0);
        if (!total) return "0%";
        return ((value/total)*100).toFixed(1) + "%";
      };

      // ====== GR√ÅFICO: Top dispositivos (barras) ======
      {
        const el = document.getElementById("chartDevice");
        if (el && devL.length) {
          new Chart(el, {
            type: "bar",
            data: {
              labels: devL,
              datasets: [{
                label: "Cantidad",
                data: toNums(devV),
                backgroundColor: "rgba(187,134,252,0.55)",
                borderColor: "#bb86fc",
                borderWidth: 1.5
              }]
            },
            options: {
              responsive:true,
              maintainAspectRatio:false,
              elements:{ bar:{ borderRadius:4 } },
              plugins:{
                legend:{ display:false },
                datalabels:{
                  display:true,
                  color:'#fff',
                  anchor:'end',
                  align:'top',
                  formatter:(value)=> value,
                  font:{ weight:'bold', size:13 }
                }
              },
              scales:{
                y:{
                  beginAtZero:true,
                  ticks:{ precision:0, color:'#aaa' },
                  grid:{ color:'#222' }
                },
                x:{
                  ticks:{ maxRotation:45, minRotation:0, color:'#aaa' },
                  grid:{ color:'#222' }
                }
              }
            }
          });
        } else if (el) {
          console.warn("DEBUG: chartDevice sin datos, ocultando card");
          el.parentElement.style.display = "none";
        }
      }

      // ====== GR√ÅFICO: Top s√≠ntomas (barras) ======
      {
        const el = document.getElementById("chartSymptom");
        if (el && symL.length) {
          new Chart(el, {
            type: "bar",
            data: {
              labels: symL,
              datasets: [{
                label: "Cantidad",
                data: toNums(symV),
                backgroundColor: "rgba(3,218,198,0.4)",
                borderColor: "rgba(3,218,198,1)",
                borderWidth: 1.5
              }]
            },
            options: {
              responsive:true,
              maintainAspectRatio:false,
              elements:{ bar:{ borderRadius:4 } },
              plugins:{
                legend:{ display:false },
                datalabels:{
                  display:true,
                  color:'#fff',
                  anchor:'end',
                  align:'top',
                  formatter:(value)=> value,
                  font:{ weight:'bold', size:13 }
                }
              },
              scales:{
                y:{
                  beginAtZero:true,
                  ticks:{ precision:0, color:'#aaa' },
                  grid:{ color:'#222' }
                },
                x:{
                  ticks:{ maxRotation:45, minRotation:0, color:'#aaa' },
                  grid:{ color:'#222' }
                }
              }
            }
          });
        } else if (el) {
          console.warn("DEBUG: chartSymptom sin datos, ocultando card");
          el.parentElement.style.display = "none";
        }
      }

      // ====== GR√ÅFICO: Categor√≠as (pie) ======
      {
        const el = document.getElementById("chartCategory");
        if (el && catL.length) {
          new Chart(el, {
            type: "pie",
            data: {
              labels: catL,
              datasets: [{
                data: toNums(catV),
                backgroundColor: [
                  "rgba(187,134,252,0.75)",
                  "rgba(3,218,198,0.75)",
                  "rgba(255,112,67,0.75)",
                  "rgba(255,183,77,0.75)",
                  "rgba(129,212,250,0.75)"
                ],
                borderColor: "#1e1e1e",
                borderWidth: 1
              }]
            },
            options: {
              responsive:true,
              maintainAspectRatio:false,
              plugins:{
                legend:{
                  position:'bottom',
                  labels:{ color:'#e0e0e0', padding:12, font:{size:12} }
                },
                datalabels:{
                  display:true,
                  color:'#fff',
                  formatter:pctFormatter,
                  font:{ weight:'bold', size:13 }
                }
              }
            }
          });
          el.style.aspectRatio = "1 / 1";
        } else if (el) {
          console.warn("DEBUG: chartCategory sin datos, ocultando card");
          el.parentElement.style.display = "none";
        }
      }

      // ====== GR√ÅFICO: Criticidad (pie) ======
      {
        const el = document.getElementById("chartCrit");
        if (el && criL.length) {
          const colorMap = {
            "critica": "rgba(244,67,54,0.8)",    // rojo
            "alta":    "rgba(255,152,0,0.8)",    // naranja
            "media":   "rgba(255,235,59,0.8)",   // amarillo
            "baja":    "rgba(76,175,80,0.8)"     // verde
          };
          const colors = criL.map(
            lvl => colorMap[lvl.toLowerCase()] || "rgba(187,134,252,0.7)"
          );

          new Chart(el, {
            type: "pie",
            data: {
              labels: criL,
              datasets: [{
                data: toNums(criV),
                backgroundColor: colors,
                borderColor: "#1e1e1e",
                borderWidth: 1
              }]
            },
            options: {
              responsive:true,
              maintainAspectRatio:false,
              plugins:{
                legend:{
                  position:'bottom',
                  labels:{ color:'#e0e0e0', padding:12, font:{size:12} }
                },
                datalabels:{
                  display:true,
                  color:'#fff',
                  formatter:pctFormatter,
                  font:{ weight:'bold', size:13 }
                }
              }
            }
          });
          el.style.aspectRatio = "1 / 1";
        } else if (el) {
          console.warn("DEBUG: chartCrit sin datos, ocultando card");
          el.parentElement.style.display = "none";
        }
      }

      console.log("DEBUG: loadStats() FIN OK");
    } catch (e) {
      console.error("Error en loadStats():", e);
      showError("No se pudieron cargar los datos desde /api/stats.");
      document.querySelectorAll('.card').forEach(c => c.style.display = 'none');
      const nNode = document.getElementById("n_casos");
      if (nNode) nNode.textContent = "0";
    }
  }

  console.log("DEBUG: iniciando loadStats()");
  loadStats();
</script>
